# CLAUDE.md — Project Rules for Agent Incident Triage

## Non-Negotiable Rules

- NEVER write "Co-Authored-By", "generated by Claude", "generated with Claude", or any AI attribution in commit messages, PR descriptions, PR comments, code comments, or files.
- NEVER push directly to master or main. Always use feature branches and PRs.
- NEVER merge PRs. Only the human merges.
- NEVER force-push unless explicitly asked.
- NEVER rebase onto master. Use merge-based PR flow only.
- Follow the milestone plan strictly. No scope creep.
- Keep the baseline repo stack, architecture, and conventions exactly as-is. Do NOT upgrade Next.js, change tooling, or add new frameworks.

## Repo Structure

```
apps/web/          → Next.js 15 (App Router) frontend
services/api/      → FastAPI backend (Poetry, SQLAlchemy)
infra/             → Docker Compose (Postgres + Redis)
```

Root scripts: `run.sh`, `test.sh`, `install.sh`
CI: `.github/workflows/ci.yml`

## Branching & Commits

Branch naming: `feat/*`, `fix/*`, `chore/*`, `docs/*`

Commit message tags (no parentheses, no co-author):
`feat:`, `fix:`, `chore:`, `docs:`, `test:`, `refactor:`, `ci:`, `build:`, `perf:`, `style:`

Keep commits small (<400 LOC). Each commit must keep the repo runnable.

## Python Conventions

- snake_case functions, PascalCase classes, SCREAMING_SNAKE constants
- Import paths: `from services.api.src.api.xxx import yyy`
- `pyproject.toml` sets `pythonpath = ["../.."]`
- Migrations: raw SQL in `services/api/migrations/00N_*.sql`
- `@dataclass(frozen=True)` for domain value objects
- Pydantic `BaseModel` for schemas and API models
- FastAPI router + `Depends()` for engine injection
- Dependency override pattern for tests: import the module, use `triage_module._engine`

## TypeScript Conventions

- camelCase functions, PascalCase components and interfaces
- `'use client'` on all interactive components
- Inline styles (`style={{}}`) — no CSS frameworks
- `useEffect` + `useState` for data fetching
- API client in `apps/web/src/lib/api.ts`, types in `types.ts`

## Testing

- Backend: pytest, run from `services/api/` via `poetry run pytest`
- Frontend: vitest, run from `apps/web/` via `npm run test`
- SQLite in-memory for test DB: use `StaticPool` + `check_same_thread=False`
- Set `os.environ["RUN_MIGRATIONS"] = "false"` before importing app in route tests
- Integration tests marked `@pytest.mark.integration`, excluded by default
- Every PR must pass `./test.sh` before merge

## File Ownership (for agent teams)

- **DB/Migrations**: `services/api/src/api/db/`, `services/api/migrations/`
- **Backend**: `services/api/src/api/routes/`, `services/api/src/api/core/`, `services/api/src/api/adapters/`, `services/api/src/api/domains/`, `services/api/src/api/schemas/`
- **Frontend**: `apps/web/src/`
- **Docs/CI**: `README.md`, `PLAN.md`, `.github/`, `infra/`, `run.sh`, `test.sh`, `install.sh`, `.env.example`
- **QA**: `services/api/tests/`, `apps/web/src/lib/api.test.ts`

## PR Workflow

1. Work on a feature branch
2. Keep commits small and descriptive
3. Push branch, create PR targeting master
4. Always include PR link in conversation
5. Wait for human to merge — never merge yourself
6. After merge, pull master before starting next task

## Environment Variables

Backend (`services/api`):
- `DATABASE_URL` — defaults to `sqlite:///./local.db`
- `OPENAI_API_KEY` — empty = stub responses
- `OPENAI_MODEL_TEXT`, `OPENAI_MODEL_STT`, `OPENAI_MODEL_TTS`
- `ACTIVE_DOMAINS` — comma-separated, default `medical`
- `CORS_ORIGIN` — Vercel frontend URL

Frontend (`apps/web`):
- `NEXT_PUBLIC_API_URL` — defaults to `http://127.0.0.1:8000`

## Deployment

- Frontend: Vercel (Root Directory = `apps/web`, auto-deploys on merge to master)
- Backend: Railway (Root Directory = `services/api`, Dockerfile + railway.toml)

## Domain Status

- **Medical**: Active, fully implemented (schemas, rules, pipeline, UI)
- **SRE**: Inactive scaffold ("Coming soon")
- **Crypto**: Inactive scaffold ("Coming soon")
